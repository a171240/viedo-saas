name: CI Regress

on:
  push:
    branches: [main]
  pull_request:

permissions: write-all

jobs:
  regress:
    runs-on: ubuntu-latest
    timeout-minutes: 35

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: videofly
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres -d videofly"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

    env:
      # App runtime (required by src/env.mjs)
      NEXT_PUBLIC_APP_URL: http://localhost:3002
      BASE_URL: http://localhost:3002
      BETTER_AUTH_SECRET: ci_test_better_auth_secret
      GOOGLE_CLIENT_ID: ci_test_google_client_id
      GOOGLE_CLIENT_SECRET: ci_test_google_client_secret
      STRIPE_API_KEY: sk_test_ci_dummy
      STRIPE_WEBHOOK_SECRET: whsec_ci_dummy
      RESEND_API_KEY: re_ci_dummy
      RESEND_FROM: noreply@example.com

      # DB + dev-bypass (used by UI regression scripts)
      DATABASE_URL: postgresql://postgres:postgres@localhost:5432/videofly
      DEV_BYPASS_AUTH: "true"
      DEV_BYPASS_AUTH_ALLOW_PROD: "true"
      DEV_BYPASS_USER_EMAIL: dev@example.com
      NEXT_PUBLIC_DEV_BYPASS_AUTH: "true"
      PORT: "3002"

      # Smoke scripts
      AI_CALLBACK_SECRET: ci_test_callback_secret
      COST_PER_CREDIT_USD: "0.03"

      # CI hygiene
      NEXT_TELEMETRY_DISABLED: "1"
      NODE_OPTIONS: --max_old_space_size=4096

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Enable Corepack
        run: corepack enable

      - name: Install Dependencies
        run: corepack pnpm install --frozen-lockfile

      - name: Install Playwright (Chromium)
        run: corepack pnpm exec playwright install --with-deps chromium

      - name: Apply DB Schema (Drizzle)
        run: corepack pnpm db:push

      - name: Build (Next.js)
        id: build
        run: |
          set +e
          corepack pnpm build 2>&1 | tee build.log
          echo "exit_code=${PIPESTATUS[0]}" >> "$GITHUB_OUTPUT"
          # Don't fail this step yet; we want to post diagnostics first.
          exit 0

      - name: Post Build Failure Tail (Commit Comment)
        if: steps.build.outputs.exit_code != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            const raw = fs.readFileSync('build.log', 'utf8');
            const lines = raw.split(/\r?\n/);
            const tail = lines.slice(-160).join('\n').slice(0, 65000);

            await github.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: [
                'CI build failed at `corepack pnpm build`.',
                '',
                'Tail of `build.log`:',
                '```',
                tail,
                '```',
              ].join('\\n'),
            });

      - name: Fail If Build Failed
        if: steps.build.outputs.exit_code != '0'
        run: exit 1

      - name: Start Server
        run: |
          # Next.js `output: standalone` requires static assets + public to be co-located.
          mkdir -p .next/standalone/.next
          cp -R .next/static .next/standalone/.next/
          cp -R public .next/standalone/

          nohup node .next/standalone/server.js > app-server.log 2>&1 &
          echo $! > app-server.pid

      - name: Wait For Server
        run: |
          for i in $(seq 1 90); do
            if curl -fsS -o /dev/null -I "http://localhost:3002/"; then
              echo "server ready"
              exit 0
            fi
            sleep 2
          done
          echo "server did not become ready"
          tail -n 200 app-server.log || true
          exit 1

      - name: P0-01/P0-02 Routes Smoke
        run: node scripts/p0-01-routes-smoke.mjs

      - name: P0-03 Credibility Smoke
        run: node scripts/p0-03-credibility-smoke.mjs

      - name: P0-04 Pricing Smoke
        run: node scripts/p0-04-pricing-smoke.mjs

      - name: P0-06 ZH i18n Smoke
        run: node scripts/p0-06-zh-smoke.mjs

      - name: P0-05 Reference Consistency Smoke
        run: node scripts/p0-05-reference-consistency-smoke.mjs

      - name: P0-07 Credits Breakdown Smoke
        run: node scripts/p0-07-credits-breakdown-smoke.mjs

      - name: P0-09 Cookie Consent Smoke
        run: node scripts/p0-09-cookie-consent-smoke.mjs

      - name: P0-08 Model Capabilities Check
        run: corepack pnpm exec tsx scripts/p0-08-model-capabilities-check.ts

      - name: P1-01 UI/Flow Regression
        run: node scripts/p1-01-ui-flow.mjs

      - name: P1-02 Template Build Check
        run: corepack pnpm exec tsx scripts/p1-02-template-build-check.ts

      - name: P1-05 Brand Kit Regression
        run: node scripts/p1-05-playwright.mjs

      - name: P1-06 Share/Remix Regression
        run: corepack pnpm exec tsx scripts/p1-06-share-remix.ts

      - name: P2-03/P2-04 Safeguards UI
        run: node scripts/p2-03-04-safeguards-ui.mjs

      - name: P2-01 Recovery Smoke
        run: corepack pnpm exec tsx scripts/p2-01-recovery-smoke.ts

      - name: P2-02 Admin Analytics Cost Check
        run: corepack pnpm exec tsx scripts/p2-02-admin-analytics-check.ts

      - name: P0-10 Callback Smoke
        run: corepack pnpm exec tsx scripts/p0-10-callback-smoke.ts

      - name: Typecheck
        run: corepack pnpm typecheck

      - name: Lint
        run: corepack pnpm lint

      - name: Stop Dev Server
        if: always()
        run: |
          if [ -f app-server.pid ]; then
            kill "$(cat app-server.pid)" || true
          fi
          tail -n 200 app-server.log || true
