# VideoFly 迁移决策点分析

## 文档信息
- **版本**: 1.0
- **创建日期**: 2025-01-16
- **目的**: 帮助项目方做出明智的技术决策

---

## 决策点总览

| # | 决策点 | 重要程度 | 依赖其他决策 |
|---|--------|---------|-------------|
| 1 | ORM 选择 (Kysely vs Drizzle) | 🔴 高 | 无 |
| 2 | 认证方案保留/变更 | 🔴 高 | 无 |
| 3 | tRPC 去留策略 | 🟡 中 | 无 |
| 4 | auth-proxy 服务处理 | 🟢 低 | 无 |
| 5 | UI 组件库管理方式 | 🟡 中 | 无 |
| 6 | Server Actions 采用程度 | 🟡 中 | 8 |
| 7 | 数据库 Schema 迁移策略 | 🔴 高 | 1 |
| 8 | API 架构 (REST vs tRPC vs SA) | 🟡 中 | 3 |
| 9 | TypeScript 路径别名设计 | 🟢 低 | 无 |
| 10 | 环境变量管理方式 | 🟢 低 | 无 |
| 11 | 迁移执行方式 (渐进 vs 一次性) | 🔴 高 | 无 |
| 12 | 是否保留 auth-proxy | 🟢 低 | 无 |
| 13 | 包管理工具选择 | 🟢 低 | 无 |
| 14 | 数据库迁移工具选择 | 🟡 中 | 1 |
| 15 | 支付提供商优先级 | 🟡 中 | 无 |

图例: 🔴 高影响 | 🟡 中等影响 | 🟢 低影响

---

## 决策点详解

---

### 🔴 决策 1: ORM 选择 (Kysely vs Drizzle)

#### 问题描述
当前项目使用 Kysely 作为查询构建器。参考项目 mksaas-template 和 sora2app-video 都使用 Drizzle ORM。

#### 选项

| 选项 | 优点 | 缺点 | 迁移成本 |
|------|------|------|---------|
| **保持 Kysely** | • 无需重写 schema<br>• 代码已稳定<br>• 类型安全优秀 | • 社区较小<br>• 文档较少<br>• 参考项目不一致 | 低 |
| **迁移到 Drizzle** | • 社区更活跃<br>• 文档更完善<br>• 与参考项目一致<br>• 有迁移工具 | • 需要重写 schema<br>• 测试工作量大<br>• 可能引入 bug | 高 |

#### 判断依据

| 因素 | Kysely | Drizzle | 权重 |
|------|--------|---------|------|
| 当前代码稳定性 | ✅ 已验证 | ⚠️ 需验证 | 高 |
| 迁移风险 | 低 | 高 | 高 |
| 社区活跃度 | 中 | 高 | 中 |
| 学习曲线 | 已熟悉 | 需学习 | 低 |
| 参考项目一致性 | ❌ | ✅ | 低 |
| 未来可维护性 | 中 | 高 | 中 |

#### 数据支持

| 指标 | Kysely | Drizzle |
|------|--------|---------|
| GitHub Stars | 3.6k | 19.4k |
| 周下载量 | ~300k | ~700k |
| 维护状态 | 活跃 | 活跃 |
| TypeScript 支持 | 优秀 | 优秀 |

#### 我的建议

**推荐: 保持 Kysely**

**理由**:
1. **风险控制**: 迁移到 Drizzle 需要重写所有 schema，风险高
2. **时间成本**: 预估额外需要 3-5 天
3. **功能对等**: Kysely 和 Drizzle 在功能上差别不大
4. **代码已稳定**: 当前代码已经在生产环境验证

**何时考虑迁移到 Drizzle**:
- 需要 Drizzle 特有的功能 (如 Drizzle Kit)
- 团队更熟悉 Drizzle
- 未来计划大量使用 Drizzle 生态系统

---

### 🔴 决策 2: 认证方案保留/变更

#### 问题描述
当前使用 Better Auth (从 NextAuth 迁移而来)。需要确认是否继续使用 Better Auth。

#### 选项

| 选项 | 优点 | 缺点 | 迁移成本 |
|------|------|------|---------|
| **保持 Better Auth** | • 已集成<br>• 代码稳定<br>• 无需改动 | • 相对较新 | 无 |
| **回到 NextAuth** | • 更成熟<br>• 文档更完善 | • 需要重写<br>• 功能降级 | 高 |
| **使用 Clerk/Auth0** | • 托管服务<br>• 功能丰富 | • 成本高<br>• 依赖第三方 | 中 |

#### 判断依据

| 因素 | Better Auth | 评估 |
|------|-------------|------|
| 当前稳定性 | ✅ 生产验证 | 保持 |
| OAuth 支持 | ✅ GitHub, Google | 满足需求 |
| 会话管理 | ✅ 自定义表 | 满足需求 |
| 类型安全 | ✅ 优秀 | 满足需求 |
| 学习成本 | ✅ 团队已熟悉 | 低 |
| 社区支持 | ⚠️ 较新 | 可接受 |

#### 我的建议

**推荐: 保持 Better Auth**

**理由**:
1. 已完成从 NextAuth 的迁移
2. 功能满足当前需求
3. 无需额外成本

---

### 🟡 决策 3: tRPC 去留策略

#### 问题描述
当前 tRPC 用于 K8s、Stripe 等功能。新功能使用 REST API (`/api/v1/`)。需要决定 tRPC 的处理方式。

#### 选项

| 选项 | 描述 | 优点 | 缺点 | 工作量 |
|------|------|------|------|--------|
| **完全移除** | 迁移所有 tRPC 到 REST/SA | • 架构统一<br>• 减少依赖 | • 需重写代码<br>• 前端改动大 | 高 |
| **保留但标记 legacy** | 保留现有代码，不再新增 | • 风险低<br>• 兼容性好 | • 技术债 | 低 |
| **逐步迁移** | 新功能用 REST，旧功能不动 | • 平衡方案 | • 架构不统一 | 中 |

#### 判断依据

**tRPC 使用情况分析**:
```
当前 tRPC 路由:
├── auth.ts        # 认证相关 (可被 Better Auth 替代)
├── customer.ts    # 客户管理 (可能常用)
├── stripe.ts      # Stripe 集成 (REST API 已有)
└── k8s.ts         # K8s 集成 (特定功能)
```

**使用频率评估**:
- 高频使用: `customer.ts` (用户信息)
- 中频使用: `stripe.ts` (订阅管理)
- 低频使用: `k8s.ts` (K8s 功能)
- 可移除: `auth.ts` (Better Auth 已覆盖)

#### 我的建议

**推荐: 保留但标记 legacy**

**具体方案**:
1. **保留现有 tRPC 端点**，不做改动
2. **标记为 legacy**，在代码注释中说明
3. **新功能使用 Server Actions 或 REST API**
4. **制定迁移计划**，未来逐步迁移

**代码示例**:
```typescript
// src/trpc/router.ts
/**
 * @deprecated Legacy tRPC router
 * 新功能请使用 Server Actions 或 REST API (/api/v1/)
 * 计划在未来版本中移除
 */
export const appRouter = router({
  // ... 现有路由
})
```

---

### 🟡 决策 8: API 架构 (REST vs tRPC vs Server Actions)

#### 问题描述
需要确定新功能的 API 架构选择。

#### 对比分析

| 特性 | REST API | tRPC | Server Actions |
|------|----------|------|----------------|
| 类型安全 | 需手动 | ✅ 自动 | ✅ 自动 |
| 客户端复杂度 | 中 | 低 | 最低 |
| Webhook 支持 | ✅ 原生 | ❌ 需要适配 | ❌ 不支持 |
| 外部调用 | ✅ 支持 | ❌ 不支持 | ❌ 不支持 |
| 表单处理 | 中 | 中 | ✅ 最佳 |
| 缓存 | ✅ HTTP 缓存 | ❌ 无 | ⚠️ 需手动 |
| 代码量 | 多 | 中 | 少 |

#### 使用场景建议

| 场景 | 推荐方案 | 理由 |
|------|---------|------|
| AI 回调 | REST API | 需要 webhook，外部调用 |
| 支付 webhooks | REST API | 第三方服务调用 |
| 视频生成 | Server Actions | 表单提交，复杂业务逻辑 |
| 积分查询 | Server Actions | 简单查询，类型安全 |
| 视频列表 | REST API | 可缓存，分页 |
| 文件上传 | REST API | 支持流式上传 |

#### 我的建议

**推荐: 混合架构**

```
API 分层策略:
├── Server Actions  # 表单操作、简单查询
│   ├── 视频生成
│   ├── 积分查询
│   └── 用户操作
│
├── REST API        # 外部调用、复杂查询
│   ├── /api/v1/video/*      # 视频相关
│   ├── /api/v1/credit/*     # 积分相关
│   ├── /api/v1/upload/*     # 文件上传
│   └── /api/v1/callback/*   # AI 回调
│
└── tRPC (legacy)   # 现有功能，保持不变
    ├── customer
    ├── stripe
    └── k8s
```

---

### 🔴 决策 7: 数据库 Schema 迁移策略

#### 问题描述
数据库 schema 定义需要迁移到新结构。

#### 选项

| 选项 | 描述 | 风险 | 工作量 |
|------|------|------|--------|
| **直接迁移** | 复制 schema 代码到新位置 | 低 | 低 |
| **重构优化** | 同时优化 schema 结构 | 中 | 中 |
| **重新设计** | 根据新需求重新设计 | 高 | 高 |

#### 判断依据

**当前 Schema 评估**:
```
✅ 优点:
  - 表结构设计合理
  - 索引配置正确
  - 关系定义清晰
  - 枚举使用得当

⚠️ 可优化:
  - 部分表名可更规范
  - 部分字段可合并
  - 索引可能需要调整
```

#### 我的建议

**推荐: 直接迁移，暂不重构**

**理由**:
1. 迁移本身已够复杂，避免同时重构
2. 当前 schema 已经生产验证
3. 可在迁移完成后单独优化

**迁移后优化计划**:
1. 迁移完成后 1-2 周
2. 分析查询性能
3. 识别优化点
4. 逐步优化

---

### 🟡 决策 5: UI 组件库管理方式

#### 问题描述
shadcn/ui 组件的管理方式。

#### 选项

| 选项 | 描述 | 优点 | 缺点 |
|------|------|------|------|
| **直接复制** | 复制所有组件到 src/components/ui | • 简单直接<br>• 完全控制 | • 与 shadcn 脱节<br>• 难以更新 |
| **保持 shadcn** | 继续使用 shadcn CLI | • 可获取更新<br>• 标准实现 | • 依赖 CLI |
| **混合方式** | 自定义组件放自定义位置 | • 平衡方案 | • 结构复杂 |

#### 我的建议

**推荐: 直接复制 + 标记自定义**

**具体方案**:
```
src/components/ui/
├── button.tsx       # shadcn 原版
├── card.tsx         # shadcn 原版
├── ...
└── video-player/    # 自定义组件 (不在 shadcn)
```

**维护策略**:
1. 原版 shadcn 组件不修改
2. 需要自定义时创建新组件
3. 定期检查 shadcn 更新

---

### 🔴 决策 11: 迁移执行方式

#### 问题描述
选择渐进式迁移还是一次性迁移。

#### 选项

| 选项 | 描述 | 风险 | 时间 | 回滚难度 |
|------|------|------|------|---------|
| **一次性迁移** | 完成所有迁移后一次性上线 | 高 | 3-4 周 | 困难 |
| **渐进式迁移** | 分阶段迁移，逐步切换 | 低 | 4-6 周 | 容易 |

#### 对比分析

| 因素 | 一次性迁移 | 渐进式迁移 |
|------|-----------|-----------|
| 代码冲突 | 多 | 少 |
| 测试复杂度 | 高 | 低 |
| 上线风险 | 高 | 低 |
| 开发效率 | 中 | 高 |
| 架构一致性 | 好 | 中 |

#### 渐进式迁移方案

**阶段 1: 基础设施** (1 周)
- 创建新目录结构
- 迁移工具配置
- 设置 CI/CD

**阶段 2: 核心模块** (2 周)
- 迁移数据库层
- 迁移业务逻辑
- 迁移认证

**阶段 3: UI 和 API** (1 周)
- 迁移 UI 组件
- 迁移 API 路由

**阶段 4: 测试和部署** (1 周)
- 全面测试
- 灰度发布
- 全量上线

#### 我的建议

**推荐: 渐进式迁移**

**理由**:
1. 风险可控，每个阶段都可回滚
2. 可以边迁移边开发新功能
3. 测试更充分
4. 团队适应时间更充足

---

### 🟡 决策 6: Server Actions 采用程度

#### 问题描述
Server Actions 在新架构中的使用范围。

#### 选项

| 选项 | 描述 | 适用场景 |
|------|------|---------|
| **全面采用** | 所有 API 用 SA | 表单密集型应用 |
| **选择性采用** | 表单用 SA，其他用 REST | 平衡方案 |
| **最小采用** | 仅简单操作用 SA | 传统 API 架构 |

#### 使用场景分析

**推荐使用 Server Actions**:
- ✅ 视频生成 (表单提交)
- ✅ 用户注册/登录
- ✅ 简单查询 (积分余额)
- ✅ 文件上传 (配合 FormData)

**推荐使用 REST API**:
- ✅ AI 回调 (webhook)
- ✅ 视频列表 (分页、缓存)
- ✅ 支付 webhook
- ✅ 第三方集成

#### 我的建议

**推荐: 选择性采用**

**原则**:
1. **表单操作优先 SA** - 代码更简洁
2. **Webhook 必须用 REST** - 外部调用
3. **复杂查询用 REST** - 更灵活

---

### 🟢 决策 12: 是否保留 auth-proxy

#### 问题描述
`apps/auth-proxy` 的处理方式。

#### 分析

**auth-proxy 当前用途**:
```
用途调查:
├── 是否用于特殊认证流程?
├── 是否有特殊 OAuth 需求?
└── 是否可被 Next.js 中间件替代?
```

**判断流程**:
```
1. 检查 auth-proxy 代码
2. 确认是否有特殊逻辑
3. 评估是否可合并到主应用
4. 决定保留或移除
```

#### 我的建议

**需要先调查，再决策**

**调查清单**:
- [ ] 查看 auth-proxy 源码
- [ ] 确认使用场景
- [ ] 检查依赖关系
- [ ] 评估迁移成本

**可能的决策**:
- 如果无特殊用途 → 移除
- 如果有特殊逻辑 → 合并到主应用
- 如果必须独立 → 保留

---

### 🟡 决策 14: 数据库迁移工具选择

#### 问题描述
数据库 schema 迁移使用什么工具。

#### 选项

| 选项 | 描述 | 优点 | 缺点 |
|------|------|------|------|
| **保持现有** | 继续用现有迁移方案 | 无改动 | 可能不完善 |
| **Drizzle Kit** | Drizzle 的迁移工具 | 功能完善 | 需要适配 Kysely |
| **Prisma Migrate** | 使用 Prisma 迁移 | 成熟 | 引入新依赖 |
| **自定义脚本** | 写 TypeScript 脚本 | 完全控制 | 需要维护 |

#### 我的建议

**推荐: 保持现有 + 优化**

**方案**:
1. 保持当前迁移脚本
2. 增加回滚支持
3. 增加迁移验证
4. 文档化迁移流程

---

### 🟢 决策 9: TypeScript 路径别名设计

#### 问题描述
TypeScript 路径别名的组织方式。

#### 选项对比

| 方案 | 别名设计 | 优点 | 缺点 |
|------|---------|------|------|
| **扁平化** | `@/db`, `@/services` | 简单直观 | 可能冲突 |
| **分层** | `@/lib/db`, `@/lib/services` | 结构清晰 | 路径更长 |
| **模块化** | `@db`, `@services` | 简洁 | 需要更多配置 |

#### 我的建议

**推荐: 扁平化设计**

```json
{
  "paths": {
    "@/*": ["./src/*"],
    "@/components/*": ["./src/components/*"],
    "@/lib/*": ["./src/lib/*"],
    "@/services/*": ["./src/services/*"],
    "@/db/*": ["./src/db/*"],
    "@/ai/*": ["./src/ai/*"],
    "@/config/*": ["./src/config/*"],
    "@/hooks/*": ["./src/hooks/*"],
    "@/types/*": ["./src/types/*"]
  }
}
```

**理由**:
1. 清晰直观
2. 避免顶层冲突
3. 易于维护

---

### 🟢 决策 10: 环境变量管理方式

#### 问题描述
环境变量的组织和管理。

#### 选项

| 选项 | 描述 | 优点 | 缺点 |
|------|------|------|------|
| **单文件** | 所有变量在 .env | 简单 | 文件过长 |
| **分类文件** | .env.db, .env.ai 等 | 分类清晰 | 需要合并 |
| **工具管理** | 用 dotenv-flow 等 | 功能强大 | 增加依赖 |

#### 我的建议

**推荐: 单文件 + 文档**

**方案**:
```
.env.example          # 完整示例 (所有变量)
.env.local           # 本地开发 (gitignore)
.env.production      # 生产环境 (gitignore)
docs/env-vars.md     # 变量说明文档
```

---

### 🟢 决策 13: 包管理工具选择

#### 问题描述
继续使用 pnpm 还是切换到 npm/yarn。

#### 对比

| 工具 | 速度 | 磁盘空间 | monorepo | 生态 |
|------|------|---------|---------|------|
| pnpm | ⚡ 最快 | 💾 最省 | ✅ 原生 | 🟢 良好 |
| npm | 🟢 快 | 🟡 中等 | ⚠️ 需要配置 | ✅ 最好 |
| yarn | 🟢 快 | 🟡 中等 | ⚠️ 需要配置 | 🟢 良好 |

#### 我的建议

**推荐: 继续 pnpm**

**理由**:
1. 项目已在用 pnpm
2. 迁移到单应用后仍可用
3. 节省磁盘空间
4. 速度快

**无需变更**

---

### 🟡 决策 15: 支付提供商优先级

#### 问题描述
Stripe 和 Creem 的处理优先级。

#### 分析

**当前状态**:
- Stripe: 已集成，功能完整
- Creem: 部分集成，待完善

**业务需求**:
- 国内用户: 需要支付宝/微信支付
- 国际用户: 信用卡支付 (Stripe)

#### 我的建议

**推荐: 双轨并行**

```
支付策略:
├── 国际用户 → Stripe (优先)
│   ├── 订阅
│   └── 积分包
│
└── 国内用户 → Creem (补充)
    ├── 加密货币
    └── 其他支付方式
```

**迁移优先级**:
1. **P0**: Stripe 订阅 (已有)
2. **P1**: Creem 集成完善
3. **P2**: 其他支付方式

---

## 决策优先级矩阵

### 必须在迁移前决策

| 决策点 | 截止时间 | 负责人 |
|--------|---------|--------|
| 1. ORM 选择 |迁移启动前 | 技术负责人 |
| 2. 认证方案 | 迁移启动前 | 技术负责人 |
| 7. Schema 迁移策略 | 阶段二前 | DBA |
| 11. 迁移执行方式 | 迁移启动前 | 项目经理 |

### 可以在迁移中决策

| 决策点 | 截止时间 | 负责人 |
|--------|---------|--------|
| 3. tRPC 去留 | 阶段七 | 后端负责人 |
| 5. UI 组件管理 | 阶段五 | 前端负责人 |
| 6. Server Actions | 阶段十 | 全栈负责人 |
| 8. API 架构 | 阶段七 | 架构师 |

### 可以迁移后决策

| 决策点 | 截止时间 | 负责人 |
|--------|---------|--------|
| 12. auth-proxy | 调查后 | 运维负责人 |
| 14. 迁移工具 | 阶段二 | DBA |
| 15. 支付优先级 | 业务需求 | 产品经理 |

---

## 决策记录模板

```markdown
## 决策记录

### 决策 #: [标题]

**日期**: YYYY-MM-DD
**决策人**: [姓名]
**参与人**: [列表]

#### 背景
[描述问题和背景]

#### 选项
1. 选项 A: [描述]
2. 选项 B: [描述]
3. 选项 C: [描述]

#### 选择
**最终选择**: 选项 X

#### 理由
1. [理由 1]
2. [理由 2]
3. [理由 3]

#### 影响
- 正面: [正面影响]
- 负面: [负面影响]
- 风险: [风险及缓解措施]

#### 生效日期
YYYY-MM-DD
```

---

## 快速决策参考

### 高优先级决策 (立即决策)
1. ✅ ORM: **保持 Kysely**
2. ✅ 认证: **保持 Better Auth**
3. ✅ 迁移方式: **渐进式迁移**

### 中优先级决策 (本周内)
4. ⏳ tRPC: **保留但标记 legacy**
5. ⏳ API 架构: **混合 (REST + SA)**
6. ⏳ Server Actions: **选择性采用**

### 低优先级决策 (可延后)
7. 📅 auth-proxy: **调查后决定**
8. 📅 支付优先级: **根据业务需求**

---

## 下一步行动

1. [ ] 召开技术决策会议
2. [ ] 确认高优先级决策
3. [ ] 记录所有决策
4. [ ] 更新迁移计划
5. [ ] 开始执行迁移

---

**文档结束**
